# testtask_bets-jackpots

В попытках оптимизировать тестовое задание я понял что просто описать addBet с одной транзакцией, и таблицы/вызовы в sql запросах будет мало.

### Таблицы:

* users

| user_name  | deposit |
| ------------- | ------------- |
| pk char(50) | money |

with fillfactor == 90

Таблица пользователей и их счетов. Раз в указанное время(updateDaemonTimer) обновляется данными из operations.

* old_jackpot

| value  |
| ------------- |
| money |

Джекпот после последнего обновления. Сложив его с operations.deposit можно получить актуальный джекпот

* operations

| id | user_name | deposit  | jackpot_part |
| ------------- | ------------- | ------------ | ------------- |
| pk SERIAL | char(50) | money | money |

Недавно сделанные ставки. Переодически updateDaemon обновляет этими данными users, old_jackpot и очищает таблицу.

### Суть

За работу отвечают два цикла:

* betLoop
EventLoop в который поступают через канал ставки из addBet (множество addBet могут работать параллеьно пока имеют доступ к каналу)
Периодически делает insert накопившихся ставок в operations.
* updateDaemon
Периодически очищает operations вставляет новые данные users и old_jackpot.

Доступ к актуальному джекпоту идет осушествляется через view real_jackpot.

При слишком большом числе запросов система может рухнуть от слишком большого числа коннектов к бд, реалезовать защиту от этого можно, но я и так написал слишком много.

